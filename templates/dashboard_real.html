<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

<div id="dashboard" class="p-6 content-section active">
  <h2 class="text-2xl font-bold text-gray-800 mb-6">Painel de Acompanhamento</h2>

  <div class="grid gap-4 grid-cols-1 md:grid-cols-2 lg:grid-cols-2"> 
    <div class="bg-white shadow-md rounded-lg p-3 transition transform hover:-translate-y-1 duration-300 overflow-hidden">
      <h3 class="text-lg font-semibold text-indigo-600 mb-2">Chamados Fechados</h3>
      <ul id="listaFechados" class="text-gray-700 text-xs space-y-0.5 max-h-40 overflow-y-auto"></ul>
    </div>

    <div class="bg-white shadow-md rounded-lg p-3 transition transform hover:-translate-y-1 duration-300 overflow-hidden">
      <h3 class="text-lg font-semibold text-pink-600 mb-2">Histórico de Movimentações</h3>
      <ul id="listaMovimentacoes" class="text-gray-700 text-xs space-y-0.5 max-h-40 overflow-y-auto"></ul>
    </div>

    <div class="bg-white shadow-md rounded-lg p-3 transition transform hover:-translate-y-1 duration-300 overflow-hidden">
      <h3 class="text-lg font-semibold text-green-600 mb-2">Novos Comentários</h3>
      <ul id="listaComentarios" class="text-gray-700 text-xs space-y-0.5 max-h-40 overflow-y-auto"></ul>
    </div>

    <div class="bg-white shadow-md rounded-lg p-3 transition transform hover:-translate-y-1 duration-300">
      <h3 class="text-lg font-semibold text-purple-600 mb-2">Visão Geral</h3>
      <div class="chart-container" style="position: relative; height:150px; width:100%;">
        <canvas id="graficoChamados"></canvas>
      </div>
    </div>
  </div>
</div>

<script>
const socket = io();

function carregarDashboard() {
  fetch('/dashboard_data')
    .then(res => {
        if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
        }
        return res.json();
    })
    .then(data => {
        console.log("Dados do Dashboard:", data); 
        atualizarDashboard(data);
    })
    .catch(error => {
        console.error('Erro ao carregar dashboard:', error);
    });
}

function atualizarDashboard(data) {
  const listaFechados = document.getElementById('listaFechados');
  const listaMovimentacoes = document.getElementById('listaMovimentacoes');
  const listaComentarios = document.getElementById('listaComentarios');
  const graficoChamados = document.getElementById('graficoChamados');

  if (!listaFechados || !listaMovimentacoes || !listaComentarios || !graficoChamados) {
      console.warn("Elementos do dashboard não encontrados. Verifique se o HTML foi carregado corretamente.");
      return; 
  }

  listaFechados.innerHTML = '';
  listaMovimentacoes.innerHTML = '';
  listaComentarios.innerHTML = '';
  
  // Ordenar fechados por data mais recente
  const fechadosOrdenados = data.fechados.sort((a, b) => new Date(b.data_atualizacao) - new Date(a.data_atualizacao));
  fechadosOrdenados.forEach(f => {
    const li = document.createElement('li');
    li.className = 'text-xs truncate';
    li.innerHTML = `Chamado <strong>${f.id_chamado}</strong> fechado em ${new Date(f.data_atualizacao).toLocaleString()}`;
    listaFechados.appendChild(li);
  });
  if (fechadosOrdenados.length === 0) {
      listaFechados.innerHTML = '<li class="text-xs text-gray-500">Nenhum chamado fechado nos últimos 15 dias.</li>';
  }
 
  // Ordenar movimentações por data mais recente
  const movimentacoesOrdenadas = data.movimentacoes.sort((a, b) => new Date(b.data) - new Date(a.data));
  movimentacoesOrdenadas.forEach(m => {
    const li = document.createElement('li');
    li.className = 'text-xs truncate';
    li.innerHTML = `Chamado <strong>${m.id_chamado}</strong> ${m.tipo} ${m.valor_novo} por ${m.usuario} em ${new Date(m.data).toLocaleString()}`;
    listaMovimentacoes.appendChild(li);
  });
  if (movimentacoesOrdenadas.length === 0) {
      listaMovimentacoes.innerHTML = '<li class="text-xs text-gray-500">Nenhuma movimentação recente.</li>';
  }

  // Ordenar comentários por data mais recente
  const comentariosOrdenados = data.comentarios.sort((a, b) => new Date(b.data_hora) - new Date(a.data_hora));
  comentariosOrdenados.forEach(c => {
    const li = document.createElement('li');
    li.className = 'text-xs truncate';
    li.innerHTML = `Chamado <strong>${c.chamado_id}</strong> comentou em ${new Date(c.data_hora).toLocaleString()}`;
    listaComentarios.appendChild(li);
  });
  if (comentariosOrdenados.length === 0) {
      listaComentarios.innerHTML = '<li class="text-xs text-gray-500">Nenhum comentário recente.</li>';
  }

  if (window.graficoPizza) window.graficoPizza.destroy();
  const ctx = graficoChamados.getContext('2d');

  const emAndamentoCount = data.grafico.em_andamento !== undefined ? data.grafico.em_andamento : 0;

  window.graficoPizza = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: ['Abertos', 'Fechados', 'Em Andamento'], 
      datasets: [{
        label: 'Chamados',
        data: [data.grafico.abertos, data.grafico.fechados, emAndamentoCount], 
        backgroundColor: [
            'rgba(255, 99, 132, 0.7)',  
            'rgba(54, 162, 235, 0.7)',  
            'rgba(255, 206, 86, 0.7)' 
        ],
        borderColor: [
            'rgba(255, 99, 132, 1)',
            'rgba(54, 162, 235, 1)',
            'rgba(255, 206, 86, 1)'
        ],
        borderWidth: 1
      }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    font: {
                        size: 10
                    }
                }
            },
            tooltip: {
                enabled: true
            }
        }
    }
  });
}

document.addEventListener('DOMContentLoaded', () => {
    if (document.getElementById('dashboard')) {
        carregarDashboard();
    }
});

socket.on('atualizacao_chamado', carregarDashboard);
socket.on('novo_comentario', carregarDashboard);
socket.on('novo_chamado_criado', carregarDashboard);
socket.on('dashboard_update', atualizarDashboard);
socket.on('chamado_atualizado', carregarDashboard);
</script>